# リファクタリング TODO

## 🔧 アーキテクチャの改善

### 1. 設定管理の統一化 ✅
- [x] **Config構造体の作成**: 現在散らばっている設定値（port, voicevoxURL, tempDir, defaultSpeaker等）を統一管理
- [x] **環境変数読み込みの統一**: `loadEnvVars()` と `loadStdioEnvVars()` の重複を解消
- [x] **設定バリデーション**: 設定値の妥当性チェック機能を追加

### 2. MCPプロトコル処理の分離 ✅
- [x] **MCPハンドラーの抽出**: `cmd/stdio.go` 内のMCPプロトコル処理を独立したパッケージに移動
- [x] **共通インターフェースの定義**: HTTP/WebSocketとStdioで共通のMCPハンドラーを使用
- [x] **レスポンス生成の統一**: MCPレスポンス生成ロジックの共通化

### 3. エラーハンドリングの改善 ✅
- [x] **カスタムエラー型の定義**: アプリケーション固有のエラー型を作成
- [x] **エラーコードの統一**: MCPエラーコードの定数化と統一
- [ ] **ログレベルの導入**: デバッグ、情報、警告、エラーレベルの分離

## 📁 ファイル構造の整理

### 4. パッケージ構造の最適化 ✅
```
pkg/
├── config/          # 設定管理 ✅
│   └── config.go
├── mcp/            # MCPプロトコル処理 ✅
│   ├── handler.go  # 共通ハンドラー
│   ├── types.go    # MCP型定義
│   └── server.go   # HTTP/WebSocketサーバー
├── audio/          # 音声再生（既存） ✅
├── voicevox/       # VOICEVOX API（既存） ✅
└── errors/         # エラー定義 ✅
    └── errors.go
```

### 5. コマンド構造の整理 ✅
- [x] **main.go の作成**: `cmd/` ディレクトリ内の複数ファイルを整理
- [x] **サブコマンドの分離**: server/stdio の処理を独立したファイルに分離
- [x] **共通処理の抽出**: 初期化処理の共通化

## 🧪 テスタビリティの向上

### 6. インターフェースの導入
- [ ] **VoicevoxClient インターフェース**: テスト用のモッククライアント作成を容易に
- [ ] **AudioPlayer インターフェース**: 音声再生のテスト可能性向上
- [ ] **FileSystem インターフェース**: ファイル操作のテスト可能性向上

### 7. 依存性注入の実装
- [ ] **DIコンテナの導入**: 依存関係の管理を改善
- [ ] **ファクトリーパターンの適用**: オブジェクト生成の統一

## 🔒 セキュリティ・堅牢性の向上

### 8. 入力検証の強化
- [ ] **テキスト長制限**: 音声合成テキストの長さ制限
- [ ] **ファイルパス検証**: 一時ファイル作成時のパス検証
- [ ] **話者ID検証**: 有効な話者IDの範囲チェック

### 9. リソース管理の改善
- [ ] **一時ファイルクリーンアップ**: 古い音声ファイルの自動削除
- [ ] **コンテキストキャンセレーション**: 長時間実行処理のキャンセル対応
- [ ] **レート制限**: API呼び出し頻度の制限

## 📊 監視・ログの改善

### 10. 構造化ログの導入
- [ ] **ログライブラリの統一**: structured logging（例：logrus, zap）の導入
- [ ] **ログレベル設定**: 環境変数でのログレベル制御
- [ ] **メトリクス収集**: 音声合成回数、エラー率等の統計情報

### 11. ヘルスチェック機能
- [ ] **VOICEVOX接続チェック**: 起動時・定期的な接続確認
- [ ] **ディスク容量チェック**: 一時ディレクトリの容量監視

## 🚀 パフォーマンス最適化

### 12. 並行処理の改善
- [ ] **ワーカープール**: 音声合成処理の並行実行
- [ ] **キャッシュ機能**: 同一テキスト・話者の音声キャッシュ
- [ ] **ストリーミング対応**: 大きなテキストの分割処理

### 13. メモリ使用量の最適化
- [ ] **音声データのストリーミング**: メモリ上に全データを保持しない
- [ ] **プールパターンの適用**: オブジェクトの再利用

## 📚 ドキュメント・開発体験

### 14. 開発環境の改善 ✅
- [x] **Makefile の作成**: ビルド・テスト・リント等のタスク自動化
- [x] **Docker対応**: 開発・デプロイ用のDockerfile作成
- [x] **CI/CD設定**: GitHub Actionsでの自動テスト・ビルド

### 15. API仕様の明確化 ✅
- [x] **OpenAPI仕様書**: HTTP API用の仕様書作成
- [x] **MCP仕様書**: MCPツールの詳細仕様書作成
- [x] **使用例の充実**: README内のサンプルコード拡充

## 優先度

### 🔴 高優先度（すぐに着手） ✅ 完了
1. ✅ 設定管理の統一化
2. ✅ MCPプロトコル処理の分離
3. ✅ パッケージ構造の最適化
4. ✅ 開発環境の改善（Makefile、Docker、CI/CD）
5. ✅ API仕様の明確化（OpenAPI、MCP仕様書）

### 🟡 中優先度（次のフェーズ）
6. エラーハンドリングの改善（一部完了）
7. インターフェースの導入
8. 入力検証の強化

### 🟢 低優先度（将来的に）
9. パフォーマンス最適化
10. 監視・ログの改善

---

## 実装の進め方

1. **段階的リファクタリング**: 一度に全てを変更せず、機能ごとに段階的に実施
2. **テスト駆動**: リファクタリング前に既存機能のテストを作成
3. **後方互換性**: 既存のCLIインターフェースを維持
4. **ドキュメント更新**: コード変更と同時にドキュメントも更新
